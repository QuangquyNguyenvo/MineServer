# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘              âœ¦ ENDERVOTE SYSTEM âœ¦                          â•‘
# â•‘   Há»‡ thá»‘ng bá» phiáº¿u má»Ÿ cá»•ng The End                      â•‘
# â•‘   Cáº§n Ä‘á»§ 8 ngÆ°á»i vote Ä‘á»ƒ má»Ÿ cá»•ng End Portal               â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# HÃ€M Táº O THANH TIáº¾N TRÃŒNH (Ä‘áº·t trÆ°á»›c Ä‘á»ƒ load trÆ°á»›c)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function makeBar(current: number, max: number) :: text:
    set {_bar} to ""
    set {_total} to 20
    if {_max} <= 0:
        set {_max} to 1
    set {_ratio} to {_current} / {_max}
    if {_ratio} > 1:
        set {_ratio} to 1
    set {_filled} to floor({_ratio} * {_total})

    loop {_total} times:
        if loop-number <= {_filled}:
            set {_bar} to "%{_bar}%&aâ–ˆ"
        else:
            set {_bar} to "%{_bar}%&7â–‘"

    return {_bar}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Cáº¤U HÃŒNH
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
on load:
    set {endervote::required} to 8
    if {endervote::portal_open} is not set:
        set {endervote::portal_open} to false
    if {endervote::vote_open} is not set:
        set {endervote::vote_open} to false
    delete {endervote::voters::*}
    send "&a[EnderVote] &fHe thong bo phieu The End da duoc nap!" to console
    send "&a[EnderVote] &fCan &e%{endervote::required}% &fphieu de mo cong." to console

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# HÃ€M Má» CUá»˜C VOTE (1 PHÃšT)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startEnderVote(p: player):
    if {endervote::portal_open} is true:
        send "&5[EnderVote] &aCong The End da mo roi!" to {_p}
        play sound "entity.villager.yes" with volume 1 and pitch 1 to {_p}
        stop
    if {endervote::vote_open} is true:
        send "&5[EnderVote] &eCuoc vote dang mo! Dung &b/endervote accept &ede bo phieu." to {_p}
        play sound "ui.button.click" with volume 0.6 and pitch 1.2 to {_p}
        stop

    set {endervote::vote_open} to true
    delete {endervote::voters::*}
    set {_session} to random integer between 100000 and 999999
    set {endervote::vote_session} to {_session}

    broadcast ""
    broadcast "&8&m                                              "
    broadcast ""
    broadcast "  &5&lâœ¦ ENDER VOTE &8- &7Mo cuoc vote 1 phut"
    broadcast "  &7Dung &b/endervote accept &7de bo phieu mo cong The End."
    broadcast "  &7Thoi gian: &c1 phut&7. Neu het thoi gian, vote se bi huy."
    broadcast ""
    broadcast "&8&m                                              "
    broadcast ""

    wait 60 seconds
    if {endervote::vote_session} is {_session}:
        if {endervote::vote_open} is true:
            set {endervote::vote_open} to false
            delete {endervote::voters::*}
            broadcast ""
            broadcast "&8&m                                                  "
            broadcast ""
            broadcast "  &5&lâœ¦ ENDER VOTE &8â”‚ &cHet thoi gian. Cuoc vote da bi huy."
            broadcast "  &7Dung &b/endervote &7de mo vote moi."
            broadcast ""
            broadcast "&8&m                                                  "
            broadcast ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CHáº¶N TELEPORT VÃ€O THE END KHI CHÆ¯A Äá»¦ VOTE
# (DÃ¹ng on player teleport thay vÃ¬ on player portal
#  Ä‘á»ƒ cháº¯c cháº¯n cancel Ä‘Æ°á»£c teleportation)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
on player teleport:
    if teleport cause is end portal:
        if {endervote::portal_open} is not true:
            cancel event
            send "" to player
            send "&8&m                                              " to player
            send "  &5&lâš  Cá»”NG THE END ÄANG ÄÃ“NG!" to player
            send "" to player
            send "  &7Cáº§n Ä‘á»§ &e%{endervote::required}% &7phiáº¿u bá» phiáº¿u Ä‘á»ƒ má»Ÿ cá»•ng." to player
            set {_count} to size of {endervote::voters::*}
            if {_count} is not set:
                set {_count} to 0
            set {_bar} to makeBar({_count}, {endervote::required})
            send "  &7Hiá»‡n táº¡i: &a%{_count}%&7/&e%{endervote::required}% &8[%{_bar}%&8]" to player
            send "" to player
            send "  &bâ†’ /endervote accept &7- Bá» phiáº¿u má»Ÿ cá»•ng" to player
            send "  &bâ†’ /endervote &7       - Má»Ÿ vote / Xem tráº¡ng thÃ¡i" to player
            send "&8&m                                              " to player
            send "" to player
            play sound "block.note_block.bass" with volume 1 and pitch 0.5 to player
            play sound "entity.enderman.stare" with volume 0.5 and pitch 0.8 to player
            send title "&c&lâš  THE END" with subtitle "&7DÃ¹ng &b/endervote accept &7Ä‘á»ƒ bá» phiáº¿u!" to player for 3 seconds with fade in 0.5 seconds and fade out 1 second
            # ThÃ´ng bÃ¡o cho cáº£ server
            broadcast ""
            broadcast "&8&m                                                  "
            broadcast ""
            broadcast "  &5&lâœ¦ ENDER VOTE &8â”‚ &cCÃ³ tháº±ng cu %player% Ä‘ang lÃ©n Ä‘Ã¡nh rá»“ng khi chÆ°a Ä‘á»§ vote!"
            broadcast "  &7Náº¿u muá»‘n Ä‘Ã¡nh rá»“ng thÃ¬ hÃ£y dÃ¹ng &b/endervote&7."
            broadcast ""
            broadcast "&8&m                                                  "
            broadcast ""

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# HÃ€M Má» Cá»”NG THE END
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openEndPortal():
    set {endervote::portal_open} to true
    set {endervote::vote_open} to false
    broadcast ""
    broadcast "&8&m                                              "
    broadcast ""
    broadcast "  &5&lâœ¦âœ¦âœ¦ THE END PORTAL ÄÃƒ Má»! âœ¦âœ¦âœ¦"
    broadcast ""
    broadcast "  &7Cá»•ng sáº½ Ä‘Ã³ng sau &c30 giÃ¢y&7!"
    broadcast "  &e&lNhanh chÃ¢n vÃ o Ä‘i!"
    broadcast ""
    broadcast "&8&m                                              "
    broadcast ""

    # Hiá»‡u á»©ng Ã¢m thanh EPIC cho táº¥t cáº£ ngÆ°á»i chÆ¡i
    loop all players:
        play sound "entity.ender_dragon.growl" with volume 1 and pitch 0.5 to loop-player
        play sound "entity.wither.spawn" with volume 0.6 and pitch 1.2 to loop-player
        play sound "block.end_portal.spawn" with volume 1 and pitch 0.8 to loop-player
        send title "&5&lâœ¦ THE END âœ¦" with subtitle "&eCá»•ng Ä‘Ã£ Ä‘Æ°á»£c má»Ÿ! (30s)" to loop-player for 3 seconds with fade in 0.5 seconds and fade out 1 second

    # Countdown warning á»Ÿ 10s
    wait 20 seconds
    broadcast "  &5&lâœ¦ ENDER VOTE &8â”‚ &eCÃ²n &c&l10 giÃ¢y &etrÆ°á»›c khi Ä‘Ã³ng cá»•ng!"
    loop all players:
        play sound "block.note_block.bell" with volume 1 and pitch 1 to loop-player

    # Countdown 5s
    wait 5 seconds
    broadcast "  &5&lâœ¦ ENDER VOTE &8â”‚ &cCÃ²n &4&l5 giÃ¢y&c!"
    loop all players:
        play sound "block.note_block.bell" with volume 1 and pitch 1.5 to loop-player

    # Countdown cuá»‘i
    wait 1 second
    loop all players:
        send title "&c&l4" with subtitle "" to loop-player for 1 second
        play sound "block.note_block.hat" with volume 1 and pitch 1 to loop-player
    wait 1 second
    loop all players:
        send title "&c&l3" with subtitle "" to loop-player for 1 second
        play sound "block.note_block.hat" with volume 1 and pitch 1 to loop-player
    wait 1 second
    loop all players:
        send title "&4&l2" with subtitle "" to loop-player for 1 second
        play sound "block.note_block.hat" with volume 1 and pitch 1.2 to loop-player
    wait 1 second
    loop all players:
        send title "&4&l1" with subtitle "" to loop-player for 1 second
        play sound "block.note_block.hat" with volume 1 and pitch 1.5 to loop-player
    wait 1 second

    # ÄÃ“NG Cá»”NG
    set {endervote::portal_open} to false
    set {endervote::vote_open} to false
    delete {endervote::voters::*}

    broadcast ""
    broadcast "&8&m                                                  "
    broadcast ""
    broadcast "  &5&lâœ¦ ENDER VOTE &8â”‚ &cCá»•ng The End Ä‘Ã£ ÄÃ“NG!"
    broadcast "  &7Phiáº¿u Ä‘Ã£ Ä‘Æ°á»£c reset. Bá» phiáº¿u láº¡i báº±ng &b/endervote"
    broadcast ""
    broadcast "&8&m                                                  "
    broadcast ""

    loop all players:
        play sound "block.portal.travel" with volume 0.5 and pitch 2 to loop-player
        play sound "entity.enderman.teleport" with volume 1 and pitch 0.5 to loop-player
        send title "&c&lğŸ”’ ÄÃ“NG Cá»”NG" with subtitle "&7The End Portal Ä‘Ã£ Ä‘Ã³ng!" to loop-player for 2 seconds with fade in 0.25 seconds and fade out 0.5 seconds

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# HÃ€M Bá» PHIáº¾U
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function castEnderVote(p: player):
    if {endervote::portal_open} is true:
        send "&5[EnderVote] &aCá»•ng The End Ä‘Ã£ má»Ÿ rá»“i! VÃ o Ä‘i thÃ´i~ &5âœ¦" to {_p}
        play sound "entity.villager.yes" with volume 1 and pitch 1 to {_p}
        stop
    if {endervote::vote_open} is not true:
        send "&5[EnderVote] &eChua mo cuoc vote. Dung &b/endervote &ede mo vote 1 phut." to {_p}
        play sound "entity.villager.no" with volume 1 and pitch 1 to {_p}
        stop

    # Kiá»ƒm tra Ä‘Ã£ vote chÆ°a
    set {_uuid} to uuid of {_p}
    if {endervote::voters::%{_uuid}%} is set:
        send "&5[EnderVote] &cBáº¡n Ä‘Ã£ bá» phiáº¿u rá»“i!" to {_p}
        play sound "entity.villager.no" with volume 1 and pitch 1 to {_p}
        stop

    # Ghi nháº­n vote
    set {endervote::voters::%{_uuid}%} to name of {_p}
    set {_count} to size of {endervote::voters::*}

    # Ã‚m thanh khi vote thÃ nh cÃ´ng
    loop all players:
        play sound "entity.experience_orb.pickup" with volume 0.8 and pitch 1.2 to loop-player
        play sound "block.note_block.chime" with volume 0.5 and pitch 1 to loop-player

    # Broadcast thÃ´ng bÃ¡o vá»›i progress bar
    set {_bar} to makeBar({_count}, {endervote::required})
    broadcast ""
    broadcast "&8&m                                                  "
    broadcast ""
    broadcast "  &5&lâœ¦ ENDER VOTE &8â”‚ &f%{_p}% &7Ä‘Ã£ bá» phiáº¿u má»Ÿ The End!"
    broadcast "  &7Tiáº¿n trÃ¬nh: &a%{_count}%&7/&e%{endervote::required}% &8[%{_bar}%&8]"
    broadcast ""
    broadcast "&8&m                                                  "
    broadcast ""

    # Hiá»‡u á»©ng milestone (má»—i 25%)
    set {_progress} to {_count} / {endervote::required}
    if {_progress} >= 0.25:
        if {_progress} < 0.3:
            broadcast "  &e&lâš¡ 25%% Ä‘Ã£ hoÃ n thÃ nh! CÃ²n thÃªm vÃ i ngÆ°á»i ná»¯a thÃ´i!"
            loop all players:
                play sound "entity.player.levelup" with volume 0.5 and pitch 1.5 to loop-player
    if {_progress} >= 0.5:
        if {_progress} < 0.55:
            broadcast "  &6&lâš¡ 50%%! Ná»­a Ä‘Æ°á»ng rá»“i! Tiáº¿p tá»¥c vote nÃ o!"
            loop all players:
                play sound "entity.player.levelup" with volume 0.7 and pitch 1.2 to loop-player
    if {_progress} >= 0.75:
        if {_progress} < 0.8:
            broadcast "  &c&lâš¡ 75%%! Sáº¯p Ä‘á»§ rá»“i! Ai chÆ°a vote thÃ¬ nhanh!"
            loop all players:
                play sound "entity.player.levelup" with volume 0.9 and pitch 1 to loop-player

    # Kiá»ƒm tra Ä‘Ã£ Ä‘á»§ vote chÆ°a
    if {_count} >= {endervote::required}:
        openEndPortal()

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Lá»†NH /endervote
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
command /endervote [<text>]:
    aliases: /ev
    description: He thong bo phieu mo cong The End
    trigger:
        if arg-1 is not set:
            if {endervote::vote_open} is not true:
                if {endervote::portal_open} is not true:
                    startEnderVote(player)
                    stop

            # Hiá»ƒn thá»‹ thÃ´ng tin tráº¡ng thÃ¡i
            send ""
            send "&8&m                                              "
            send "  &5&lâœ¦ ENDER VOTE &8- &7Bá» phiáº¿u má»Ÿ The End"
            send "&8&m                                              "
            send ""
            set {_count} to size of {endervote::voters::*}
            if {_count} is not set:
                set {_count} to 0
            set {_bar} to makeBar({_count}, {endervote::required})
            send "  &7Sá»‘ phiáº¿u: &a%{_count}%&7/&e%{endervote::required}% &8[%{_bar}%&8]"
            send ""
            if {endervote::portal_open} is true:
                send "  &a&lâœ¦ Cá»”NG THE END ÄANG Má»!"
                send ""
            else if {endervote::vote_open} is true:
                send "  &eCuoc vote dang mo. Dung &b/endervote accept &ede bo phieu."
                send ""
            else:
                send "  &c&lâš  Cá»”NG THE END ÄANG ÄÃ“NG"
                send ""
                send "  &7Sá»­ dá»¥ng &b/endervote &7Ä‘á»ƒ má»Ÿ cuá»™c vote 1 phÃºt"
                send ""
            if size of {endervote::voters::*} > 0:
                send "  &7ÄÃ£ bá» phiáº¿u:"
                loop {endervote::voters::*}:
                    send "    &8â€¢ &f%loop-value%"
                send ""
            send "&8&m                                              "
            send ""
            play sound "ui.button.click" with volume 0.5 and pitch 1.2 to player

        # --- VOTE ---
        else if arg-1 is "accept" or "vote" or "yes":
            castEnderVote(player)

        # --- RESET (OP ONLY) ---
        else if arg-1 is "reset":
            if player has permission "op":
                set {endervote::portal_open} to false
                set {endervote::vote_open} to false
                delete {endervote::voters::*}
                broadcast "&5[EnderVote] &ePhieu da duoc reset boi Admin."
                loop all players:
                    play sound "entity.item.break" with volume 0.8 and pitch 1 to loop-player
            else:
                send "&cBan khong co quyen su dung lenh nay!"

        # --- FORCE OPEN (OP ONLY) ---
        else if arg-1 is "open":
            if player has permission "op":
                openEndPortal()
            else:
                send "&cBan khong co quyen su dung lenh nay!"

        # --- SET (OP ONLY) ---
        else if arg-1 starts with "set":
            if player has permission "op":
                set {_num} to arg-1
                replace all "set " with "" in {_num}
                set {_num} to {_num} parsed as number
                if {_num} is set:
                    set {endervote::required} to {_num}
                    send "&5[EnderVote] &aDa dat so phieu can thiet thanh &e%{_num}%"
                else:
                    send "&cSu dung: /endervote set <so>"
            else:
                send "&cBan khong co quyen su dung lenh nay!"

        else:
            send "&5[EnderVote] &7Lenh khong hop le. Dung &b/endervote &7de xem huong dan."
